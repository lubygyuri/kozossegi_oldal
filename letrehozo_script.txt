CREATE TABLE felhasznalo (
    EMAIL VARCHAR2(60) PRIMARY KEY NOT NULL,
    JELSZO CHAR(200) NOT NULL,
    VEZETEKNEV VARCHAR2(60) NOT NULL,
    KERESZTNEV VARCHAR2(60) NOT NULL,
    SZULETESI_DATUM DATE NOT NULL,
    NEME VARCHAR2(10) NOT NULL,
    ISKOLA VARCHAR2(100),
    MUNKAHELY VARCHAR2(100),
    CSATLAKOZAS_DATUMA DATE NOT NULL,
    PROFILKEP VARCHAR2(255)
);

CREATE TABLE fenykep_album (
    AZONOSITO NUMBER PRIMARY KEY NOT NULL,
    NEV VARCHAR2(100),
    TELJES_MERET NUMBER,
    BORITOKEP VARCHAR2(255),
    FELHASZNALO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL)
);

CREATE TABLE fenykepek (
    AZONOSITO NUMBER PRIMARY KEY NOT NULL,
    KEP VARCHAR2(200) NOT NULL,
    MERET NUMBER NOT NULL,
    FENYKEP_ALBUM_AZONOSITO NUMBER REFERENCES fenykep_album (AZONOSITO)ON DELETE CASCADE NOT NULL
);

CREATE TABLE ismeros (
    AZONOSITO NUMBER PRIMARY KEY NOT NULL,
    STATUSZ VARCHAR2(20) NOT NULL, 
    FELHASZNALO1 VARCHAR2(60) REFERENCES felhasznalo (EMAIL),
    FELHASZNALO2 VARCHAR2(60) REFERENCES felhasznalo (EMAIL)
);

CREATE TABLE bejegyzes (
    AZONOSITO NUMBER PRIMARY KEY NOT NULL,
    UZENET VARCHAR2(800) NOT NULL,
    LETREHOZAS_IDEJE TIMESTAMP NOT NULL,
    FELHASZNALO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL),
    KEP VARCHAR2(255),
    LIKES NUMBER DEFAULT 0 NOT NULL 
);

CREATE TABLE bejegyzes_like (
    BEJEGYZES_AZONOSITO NUMBER NOT NULL REFERENCES bejegyzes (AZONOSITO),
    FELHASZNALO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL),
    PRIMARY KEY (BEJEGYZES_AZONOSITO, FELHASZNALO_AZONOSITO)
);

CREATE TABLE komment (
    AZONOSITO NUMBER PRIMARY KEY NOT NULL,
    UZENET VARCHAR2(400) NOT NULL,
    LETREHOZAS_IDEJE TIMESTAMP NOT NULL,
    FELHASZNALO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL),
    BEJEGYZES_AZONOSITO NUMBER NOT NULL REFERENCES bejegyzes (AZONOSITO),
    LIKES NUMBER DEFAULT 0 NOT NULL  
);

CREATE TABLE csoport (
    AZONOSITO NUMBER PRIMARY KEY NOT NULL,
    NEV VARCHAR2(30),
    ADMIN_FELHASZNALO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL)
);

CREATE TABLE csoport_tagok (
    CSOPORT_AZONOSITO NUMBER NOT NULL REFERENCES csoport (AZONOSITO),
    FELHASZNALO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL),
    PRIMARY KEY (CSOPORT_AZONOSITO, FELHASZNALO_AZONOSITO)
);

CREATE TABLE uzenet (
    AZONOSITO NUMBER PRIMARY KEY NOT NULL,
    UZENET VARCHAR2(500) NOT NULL,
    KULDES_IDEJE TIMESTAMP NOT NULL,
    KULDO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL),
    FOGADO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL)
);

CREATE TABLE csoport_uzenet (
    AZONOSITO NUMBER PRIMARY KEY NOT NULL,
    UZENET VARCHAR2(500) NOT NULL,
    KULDES_IDEJE TIMESTAMP NOT NULL,
    KULDO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL),
    CSOPORT_AZONOSITO NUMBER NOT NULL REFERENCES csoport (AZONOSITO)
);

CREATE TABLE klub (
    NEV VARCHAR2(100) PRIMARY KEY NOT NULL,
    LEIRAS VARCHAR2(300),
    LATHATOSAG SMALLINT DEFAULT 0,
    LETREHOZAS_DATUMA DATE NOT NULL,
    ADMIN_FELHASZNALO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL)
);

CREATE TABLE klub_tagok (
    KLUB_AZONOSITO VARCHAR2(100) NOT NULL REFERENCES klub (NEV),
    FELHASZNALO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL),
    PRIMARY KEY (KLUB_AZONOSITO, FELHASZNALO_AZONOSITO)
);

CREATE TABLE klub_bejegyzes (
    AZONOSITO NUMBER PRIMARY KEY NOT NULL,
    UZENET VARCHAR2(2000) NOT NULL, 
    LETREHOZAS_IDEJE TIMESTAMP NOT NULL,
    FELHASZNALO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL),
    KLUB_AZONOSITO VARCHAR2(100) NOT NULL REFERENCES klub (NEV),
    KEP VARCHAR2(255)
);

CREATE TABLE klub_bejegyzes_like (
    KLUB_BEJEGYZES_AZONOSITO NUMBER NOT NULL REFERENCES klub_bejegyzes (AZONOSITO),
    FELHASZNALO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL),
    PRIMARY KEY (KLUB_BEJEGYZES_AZONOSITO, FELHASZNALO_AZONOSITO)
);

CREATE TABLE ERTESITESEK (
    AZONOSITO NUMBER PRIMARY KEY NOT NULL,
    UZENET VARCHAR2(200) NOT NULL,
    ERTESITES_IDEJE TIMESTAMP NOT NULL,
    FELHASZNALO_AZONOSITO VARCHAR2(60) NOT NULL REFERENCES felhasznalo (EMAIL)
);

CREATE SEQUENCE BEJEGYZES_SEQ 
  START WITH 1 
  INCREMENT BY 1;

CREATE SEQUENCE KOMMENT_SEQ 
  START WITH 1 
  INCREMENT BY 1;

CREATE SEQUENCE UZENET_SEQ 
  START WITH 1 
  INCREMENT BY 1;

CREATE SEQUENCE ISMEROS_SEQ 
  START WITH 1 
  INCREMENT BY 1;

CREATE SEQUENCE KLUB_BEJEGYZES_SEQ 
  START WITH 1 
  INCREMENT BY 1;

CREATE SEQUENCE ERTESITESEK_SEQ 
  START WITH 1 
  INCREMENT BY 1;

CREATE SEQUENCE FENYKEPALBUM_SEQ 
  START WITH 1 
  INCREMENT BY 1;

CREATE SEQUENCE FENYKEPEK_SEQ 
  START WITH 1 
  INCREMENT BY 1;

CREATE SEQUENCE CSOPORT_SEQ 
  START WITH 1 
  INCREMENT BY 1;


CREATE SEQUENCE CSOPORT_UZENET_SEQ 
  START WITH 1 
  INCREMENT BY 1;


CREATE OR REPLACE TRIGGER ERTESITESEK_AKCIO_1
AFTER INSERT ON ISMEROS
FOR EACH ROW
DECLARE
    v_keresztnev FELHASZNALO.KERESZTNEV%TYPE;
    v_vezeteknev FELHASZNALO.VEZETEKNEV%TYPE;
BEGIN
    SELECT keresztnev, vezeteknev INTO v_keresztnev, v_vezeteknev FROM FELHASZNALO WHERE EMAIL = :NEW.FELHASZNALO1;
  INSERT INTO ERTESITESEK VALUES (ERTESITESEK_SEQ.NEXTVAL, v_vezeteknev || ' ' || v_keresztnev || ' ismerősnek jelölt!' , SYSTIMESTAMP, :NEW.FELHASZNALO2);
END;
/

create or replace TRIGGER ERTESITESEK_AKCIO_2
AFTER INSERT ON BEJEGYZES_LIKE
FOR EACH ROW
DECLARE
    v_keresztnev FELHASZNALO.KERESZTNEV%TYPE;
    v_vezeteknev FELHASZNALO.VEZETEKNEV%TYPE;
    v_email BEJEGYZES.FELHASZNALO_AZONOSITO%TYPE;
BEGIN
    SELECT felhasznalo.keresztnev, felhasznalo.vezeteknev INTO v_keresztnev, v_vezeteknev FROM felhasznalo WHERE felhasznalo.email = :NEW.FELHASZNALO_AZONOSITO;
    
    SELECT bejegyzes.felhasznalo_azonosito INTO v_email FROM bejegyzes WHERE :NEW.bejegyzes_azonosito = bejegyzes.azonosito;
    
    IF :NEW.FELHASZNALO_AZONOSITO != v_email THEN
        INSERT INTO ERTESITESEK VALUES (ERTESITESEK_SEQ.NEXTVAL, v_vezeteknev || ' ' || v_keresztnev || ' felhasználónak tetszett az egyik bejegyzésed!' , SYSTIMESTAMP, v_email);
    END IF;
END;
/


create or replace TRIGGER FENYKEPALBUM_FELVETEL
BEFORE INSERT ON FENYKEP_ALBUM
FOR EACH ROW
  WHEN (new.AZONOSITO IS NULL)
BEGIN
  :new.AZONOSITO := FENYKEPALBUM_SEQ.NEXTVAL;
END;
/

CREATE OR REPLACE TRIGGER BEJEGYZES_FELVETEL
BEFORE INSERT ON BEJEGYZES
FOR EACH ROW
  WHEN (new.AZONOSITO IS NULL)
BEGIN
  :new.AZONOSITO := BEJEGYZES_SEQ.NEXTVAL;
END;
/

CREATE OR REPLACE TRIGGER KOMMENT_FELVETEL
BEFORE INSERT ON KOMMENT
FOR EACH ROW
  WHEN (new.AZONOSITO IS NULL)
BEGIN
  :new.AZONOSITO := KOMMENT_SEQ.NEXTVAL;
END;
/

CREATE OR REPLACE TRIGGER UZENET_FELVETEL
BEFORE INSERT ON UZENET
FOR EACH ROW
  WHEN (new.AZONOSITO IS NULL)
BEGIN
  :new.AZONOSITO := UZENET_SEQ.NEXTVAL;
END;
/
CREATE OR REPLACE TRIGGER ISMEROS_FELVETEL
BEFORE INSERT ON ISMEROS
FOR EACH ROW
  WHEN (new.AZONOSITO IS NULL)
BEGIN
  :new.AZONOSITO := ISMEROS_SEQ.NEXTVAL;
END;
/
CREATE OR REPLACE TRIGGER KLUB_BEJEGYZES_FELVETEL
BEFORE INSERT ON KLUB_BEJEGYZES
FOR EACH ROW
  WHEN (new.AZONOSITO IS NULL)
BEGIN
  :new.AZONOSITO := KLUB_BEJEGYZES_SEQ.NEXTVAL;
END;
/

create or replace TRIGGER FENYKEPEK_FELVETEL
BEFORE INSERT ON FENYKEPEK
FOR EACH ROW
  WHEN (new.AZONOSITO IS NULL)
BEGIN
  :new.AZONOSITO := FENYKEPEK_SEQ.NEXTVAL;
END;
/

create or replace TRIGGER CSOPORT_FELVETEL
BEFORE INSERT ON CSOPORT
FOR EACH ROW
  WHEN (new.AZONOSITO IS NULL)
BEGIN
  :new.AZONOSITO := CSOPORT_SEQ.NEXTVAL;
END;
/

create or replace TRIGGER CSOPORT_UZENET_FELVETEL
BEFORE INSERT ON CSOPORT
FOR EACH ROW
  WHEN (new.AZONOSITO IS NULL)
BEGIN
  :new.AZONOSITO := CSOPORT_UZENET_SEQ.NEXTVAL;
END;
/